# Production Docker Compose Configuration
# Uses pre-built images from Docker Hub (no local build)
# For use on target deployment machine (192.168.1.11)

services:
  docker-compose-dashboard:
    image: "mcr.microsoft.com/dotnet/nightly/aspire-dashboard:latest"
    ports:
      - "18888:18888"
    expose:
      - "18889"
      - "18890"
    networks:
      - "aspire"
    restart: "always"

  apiservice:
    # Pull image from Docker Hub instead of building locally
    image: "${APISERVICE_IMAGE:-pngan/aspireapp-apiservice:latest}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      ASPNETCORE_ENVIRONMENT: "Production"
      HTTP_PORTS: "${APISERVICE_PORT:-8080}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://docker-compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "apiservice"
    expose:
      - "${APISERVICE_PORT:-8080}"
    networks:
      - "aspire"
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${APISERVICE_PORT:-8080}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  webfrontend:
    # Pull image from Docker Hub instead of building locally
    image: "${WEBFRONTEND_IMAGE:-pngan/aspireapp-webfrontend:latest}"
    environment:
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EXCEPTION_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_EMIT_EVENT_LOG_ATTRIBUTES: "true"
      OTEL_DOTNET_EXPERIMENTAL_OTLP_RETRY: "in_memory"
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"
      ASPNETCORE_ENVIRONMENT: "Production"
      HTTP_PORTS: "${WEBFRONTEND_PORT:-8080}"
      APISERVICE_HTTP: "http://apiservice:${APISERVICE_PORT:-8080}"
      services__apiservice__http__0: "http://apiservice:${APISERVICE_PORT:-8080}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://docker-compose-dashboard:18889"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
      OTEL_SERVICE_NAME: "webfrontend"
    ports:
      # Expose webfrontend on host port 8080 for reverse proxy access
      - "${WEBFRONTEND_HOST_PORT:-8080}:${WEBFRONTEND_PORT:-8080}"
    depends_on:
      apiservice:
        condition: "service_healthy"
    networks:
      - "aspire"
    restart: "unless-stopped"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${WEBFRONTEND_PORT:-8080}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  aspire:
    driver: "bridge"
